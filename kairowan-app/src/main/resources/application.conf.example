# Ktor Server Configuration
ktor:
  deployment:
    port: 8080
  application:
    modules:
      - com.kairowan.app.ApplicationKt.module
  development: true

# Kairowan Profile
kairowan:
  profile: "uploads"

# Database Configuration (优化版)
db:
  driver: "com.mysql.cj.jdbc.Driver"
  # 性能优化参数说明：
  # - useSSL=false: 禁用 SSL，减少握手延迟（内网环境可以禁用）
  # - allowPublicKeyRetrieval=true: 允许从服务器获取公钥
  # - useServerPrepStmts=true: 使用服务器端预编译语句
  # - cachePrepStmts=true: 缓存预编译语句
  # - prepStmtCacheSize=250: 预编译语句缓存大小
  # - prepStmtCacheSqlLimit=2048: 预编译语句 SQL 长度限制
  # - rewriteBatchedStatements=true: 批量操作重写为单条语句
  # - cacheResultSetMetadata=true: 缓存结果集元数据
  # - cacheServerConfiguration=true: 缓存服务器配置
  # - elideSetAutoCommits=true: 省略不必要的 setAutoCommit 调用
  # - maintainTimeStats=false: 禁用时间统计，减少开销
  url: "jdbc:mysql://localhost:3306/kairowan_ktor?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=GMT%2B8&useServerPrepStmts=true&cachePrepStmts=true&prepStmtCacheSize=250&prepStmtCacheSqlLimit=2048&rewriteBatchedStatements=true&cacheResultSetMetadata=true&cacheServerConfiguration=true&elideSetAutoCommits=true&maintainTimeStats=false"
  user: "root"
  password: "your_password_here"

  # Flyway 配置
  flyway:
    # 是否启用 Flyway 数据库迁移（生产环境建议设为 false）
    enabled: false
    # 只在首次启动时迁移（检测到迁移历史后跳过），可显著提升后续启动速度
    runOnce: true
    # 强制执行迁移（即使 runOnce 已启用），用于手动升级
    force: false

  # 数据库预热配置
  warmup:
    # 是否在启动时预热数据库连接（会增加约 1 秒启动时间）
    # 设为 false 可加快启动，但第一个请求会稍慢
    enabled: false

  # HikariCP 连接池配置 (性能优化)
  hikari:
    # 最大连接数
    maximumPoolSize: 20
    # 最小空闲连接数（设为 1 可加快启动，按需创建更多连接）
    minimumIdle: 1
    # 连接超时时间 (毫秒) - 降低超时时间，快速失败
    connectionTimeout: 10000
    # 空闲连接超时时间 (毫秒)
    idleTimeout: 600000
    # 连接最大生命周期 (毫秒)
    maxLifetime: 1800000
    # 自动提交
    autoCommit: true
    # 连接池名称
    poolName: "KairowanHikariPool"
    # 泄漏检测阈值 (毫秒，0表示禁用)
    leakDetectionThreshold: 60000
    # 初始化失败超时 (毫秒，-1表示无限等待)
    initializationFailTimeout: -1

# Redis Configuration (优化版)
redis:
  host: "localhost"
  port: 6379
  password: "your_redis_password_here"
  timeout: 3000

  # 连接池配置
  pool:
    # 最大连接数
    maxTotal: 50
    # 最大空闲连接数
    maxIdle: 10
    # 最小空闲连接数
    minIdle: 5
    # 获取连接时的最大等待毫秒数
    maxWaitMillis: 3000
    # 在获取连接时检查有效性
    testOnBorrow: true
    # 在归还连接时检查有效性
    testOnReturn: false
    # 在空闲时检查有效性
    testWhileIdle: true

# Security
jwt:
  secret: "please-change-this-to-a-very-long-and-secure-secret-key-at-least-32-characters-long"
  issuer: "http://localhost:8080/"
  audience: "http://localhost:8080/"
  realm: "Access to system"

# Logging
logging:
  request:
    enabled: true

# Metrics
metrics:
  enabled: true
  path: "/metrics"

# CORS Configuration
cors:
  allowedOrigins: "http://localhost:3000,http://localhost:5173,http://localhost:8081"

# File Upload Configuration
file:
  uploadPath: "uploads"
  urlPrefix: "http://localhost:8080/files"
  # 启动时同步本地文件到数据库
  syncOnStartup: true
  # 仅首次同步（通过 marker 文件控制）
  syncOnce: true
  # 同步标记文件名（位于 uploadPath 下）
  syncMarker: ".kairowan_file_sync.done"
