ktor {
    deployment {
        port = 8080
        port = ${?PORT}
    }
    application {
        modules = [ com.kairowan.app.ApplicationKt.module ]
    }
}

kairowan {
    profile = "D:/kairowan/uploadPath"
    profile = ${?KAIROWAN_PROFILE}
}

# Database Configuration (优化版)
db {
    driver = "com.mysql.cj.jdbc.Driver"
    url = "jdbc:mysql://103.242.12.10:3306/kairowan_ktor?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=true&serverTimezone=GMT%2B8"
    url = ${?DB_URL}
    user = "root"
    user = ${?DB_USER}
    password = "Ghn20010413."
    password = ${?DB_PASSWORD}

    # HikariCP 连接池配置 (性能优化)
    hikari {
        # 最大连接数
        maximumPoolSize = 20
        maximumPoolSize = ${?DB_MAX_POOL_SIZE}

        # 最小空闲连接数
        minimumIdle = 5
        minimumIdle = ${?DB_MIN_IDLE}

        # 连接超时时间 (毫秒) - 降低超时时间，快速失败
        connectionTimeout = 10000

        # 空闲连接超时时间 (毫秒)
        idleTimeout = 600000

        # 连接最大生命周期 (毫秒)
        maxLifetime = 1800000

        # 连接测试查询 - 使用更快的 JDBC4 isValid() 方法
        # connectionTestQuery = "SELECT 1"  # 注释掉，使用 JDBC4 isValid()

        # 自动提交
        autoCommit = true

        # 连接池名称
        poolName = "KairowanHikariPool"

        # 泄漏检测阈值 (毫秒，0表示禁用)
        leakDetectionThreshold = 60000

        # 初始化失败超时 (毫秒，-1表示无限等待)
        initializationFailTimeout = -1
    }
}

# Redis Configuration (优化版)
redis {
    host = "103.242.12.10"
    host = ${?REDIS_HOST}
    port = 6379
    port = ${?REDIS_PORT}
    password = "ghn20010413"
    password = ${?REDIS_PASSWORD}
    timeout = 3000

    # 连接池配置
    pool {
        # 最大连接数
        maxTotal = 50
        maxTotal = ${?REDIS_MAX_TOTAL}

        # 最大空闲连接数
        maxIdle = 10
        maxIdle = ${?REDIS_MAX_IDLE}

        # 最小空闲连接数
        minIdle = 5
        minIdle = ${?REDIS_MIN_IDLE}

        # 获取连接时的最大等待毫秒数
        maxWaitMillis = 3000

        # 在获取连接时检查有效性
        testOnBorrow = true

        # 在归还连接时检查有效性
        testOnReturn = false

        # 在空闲时检查有效性
        testWhileIdle = true
    }
}

# Security
jwt {
    secret = "kairowan-secret-key-must-be-very-long-and-secure-at-least-32-chars"
    issuer = "http://localhost:8080/"
    audience = "http://localhost:8080/"
    realm = "Access to system"
}

logging {
    request {
        enabled = true
        enabled = ${?REQUEST_LOG_ENABLED}
    }
}

metrics {
    enabled = true
    enabled = ${?METRICS_ENABLED}
    path = "/metrics"
    path = ${?METRICS_PATH}
}

# CORS Configuration
cors {
    allowedOrigins = "http://localhost:3000,http://localhost:5173,http://localhost:8081"
    allowedOrigins = ${?CORS_ALLOWED_ORIGINS}
}

# File Upload Configuration
file {
    uploadPath = "uploads"
    uploadPath = ${?FILE_UPLOAD_PATH}
    urlPrefix = "http://localhost:8080/files"
    urlPrefix = ${?FILE_URL_PREFIX}
}
